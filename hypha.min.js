let o=new DOMParser;function a(t){return t instanceof Element?[t]:document.querySelectorAll(t)}function reloadFragments(e,t){(t||document).querySelectorAll("[hy-src]:not([hy-protected])").forEach(t=>{let o=t.getAttribute("hy-src");e&&!e.some(t=>{var e=o;if(t=new URL(t),e=new URL(e),t.origin!==e.origin)return!1;var r=t.pathname.split("/"),n=e.pathname.split("/");for(let t=0;t<Math.min(r.length,n.length);t++)if(r[t]!==n[t])return!1;return!0})||r(o,t)})}async function r(t,e){u(await(await fetch(t+"?hy-fragment")).text(),e,t)}function c(t,e){a(t).forEach(t=>e?t.removeAttribute("hy-protected"):t.setAttribute("hy-protected",!0))}function u(t,e,r){t=o.parseFromString(t,"text/html");let n=t.querySelector("[hy-body]")||t.body;a(e).forEach(t=>{r&&t.setAttribute("hy-src",r),t.replaceChildren(...n.childNodes),l(t),i(t)})}function h(e){var t=e.getAttribute("hy-target");if("fragment"!==t)return t;{let t=e;for(;"BODY"!==t.tagName&&!t.getAttribute("hy-src");)t=t.parentNode;return t}}async function e(t){var e=t.target,t=(t.preventDefault(),t.submitter.hasAttribute("formaction")?t.submitter.formAction:e.action),r=e.querySelector("input[name=_method]"),r=(e.getAttribute("hy-method")||r&&r.value||e.getAttribute("method")||e.method).toLowerCase(),n=new FormData(e),o="get"===r?new URLSearchParams(n):void 0,o=await fetch(t+"?hy-fragment&"+o,{method:r,redirect:"follow",body:o?void 0:n});let a=new URL(o.url);n=new URLSearchParams(a.search),n.delete("hy-fragment"),a.search=n.toString(),a=a.toString(),n=await o.text(),o=h(e);o&&("get"!==r&&c(o),u(n,o,a));let i=new URL(t).origin;n=[t,...(e.getAttribute("hy-changes")||"").trim().split(" ").map(t=>new URL(t,i).href)];"post"!==r&&"delete"!==r&&"put"!==r||(reloadFragments(n),c(o,!0))}function i(t){(t||document).querySelectorAll("form[hy-target]").forEach(t=>t.onsubmit=e)}function l(t){(t||document).querySelectorAll("a[hy-target]").forEach(e=>{e.onclick=t=>{t.preventDefault(),r(e.href,h(e))}})}addEventListener("load",()=>{l(),i(),reloadFragments()});export default reloadFragments;